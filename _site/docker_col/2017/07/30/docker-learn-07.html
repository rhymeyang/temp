


    



<!-- Include Data Base --> <!DOCTYPE html> <html lang="en" itemscope itemtype="http://schema.org/WebPage"> <head> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title>Docker系列 7 Registry | Vicky's Blog </title> <meta name=description content=""> <meta name="robots" content="index, follow"> <meta name=viewport content="width=device-width, initial-scale=1"> <meta http-equiv="cache-control" content="public"/> <meta http-equiv="pragma" content="public"> <meta name="keywords" content="Theme, Jekyll" /> <meta name="author" content="" /> <meta property="og:locale" content="en" /> <meta property="og:site_name" content="Vicky's Blog" /> <meta property="og:type" content="WebSite" /> <meta property="og:url" content="http://www.forbackup.tk/docker_col/2017/07/30/docker-learn-07.html" /> <meta property="og:description" content="" /> <meta property="og:title" content="Docker系列 7 Registry - Vicky's Blog" /> <link rel="canonical" href="http://www.forbackup.tk/docker_col/2017/07/30/docker-learn-07.html"> <link rel="alternate" type="application/rss+xml" title="Vicky's Blog" href="http://www.forbackup.tk/feed.xml"> <script type="application/ld+json"> {"@context": "http://schema.org", "@type": "WebSite", "name": "", "headline": "Vicky's Blog", "author": {"@type": "Person", "name": {"Vicky's Blog"}}, "description": "", "url": "http://www.forbackup.tk"} </script> <script type="text/javascript"> var GLOBAL_BASEURL = "http://www.forbackup.tk"; </script> <link rel="icon" type="image/png" sizes="16x16" href="http://www.forbackup.tk/assets/img/favicon/favicon-16x16.png"> <!-- #### VENDOR OFFLINE #### --> <!-- Bootstrap 3.3.6 - Offline --> <link rel="stylesheet" href="http://www.forbackup.tk/assets/vendor-off/bootstrap/css/bootstrap.min.css"> <!-- Font Awesome 5.03 - Offline --> <script defer src="http://www.forbackup.tk/assets/vendor-off/font-awesome/web-fonts-with-css/css/fontawesome-all.min.css"></script> <link rel="stylesheet" href="http://www.forbackup.tk/assets/vendor-off/fonts/space-mono/space-mono.min.css"> <link rel="stylesheet" href="http://www.forbackup.tk/assets/vendor-off/fonts/gloria-hallelujah/gloria-hallelujah.min.css"> <!-- Style Default --> <link rel="stylesheet" href="http://www.forbackup.tk/assets/stylesheets/main.css"> <!-- Google Analytics --> </head> <body> <div class="main" id="top"> <div class="container wrapper"> <div class="row"> <div class="col-sm-3 sidebar"> <div class="row avatar"> <a href="http://www.forbackup.tk/"> <img class="img-responsive center-block avatar-img" src="http://www.forbackup.tk/assets/img/avatar/blog.svg" height="165" width="165" alt="Vicky's Blog"> </a> </div> <div class="row header"> <h2><a href="http://www.forbackup.tk/">Vicky </a></h2> </div> <div class="row menu"> <ul> <li> <i class="fa fa-home" aria-hidden="true"></i>&nbsp;<a href="http://www.forbackup.tk/">Home</a> </li> <hr class="breakline"> <li class="li-folder-open"> <i style="font-size: ;" class="fas fa-folder-open"></i>&nbsp;<a class="unlink">Blog</a> </li> <li class="li-fa-edit"> <i style="font-size: ;" class="fas fa-edit" aria-hidden="true"></i>&nbsp;<a href="http://www.forbackup.tk/general/" >General</a> </li> <li class="li-fa-docker"> <i style="font-size: ;" class="fab fa-docker" aria-hidden="true"></i>&nbsp;<a href="http://www.forbackup.tk/docker_col/" >Docker</a> </li> <li class="li-fa-table"> <i style="font-size: ;" class="fas fa-table" aria-hidden="true"></i>&nbsp;<a href="http://www.forbackup.tk/data_analysis/" >Data Analysis</a> </li> <li class="li-fa-tags"> <i style="font-size: ;" class="fas fa-tags" aria-hidden="true"></i>&nbsp;<a href="http://www.forbackup.tk/blog/tags/" >Tags</a> </li> <li class="li-fa-briefcase"> <i style="font-size: ;" class="fas fa-briefcase" aria-hidden="true"></i>&nbsp;<a href="http://www.forbackup.tk/blog/projects/" >Projects</a> </li> </ul> <div class="socials"> <div class="row"> <p></p> <p></p> </div> </div> </div> </div> <div class="col-sm-9 content-main"> <!-- Include Data Base --> <article class="post" itemscope itemtype="http://schema.org/BlogPosting"> <!-- Next Version <div class="readmode"> <a id="btn-readmode" class="pull-right btn btn-default btn-readmode" href="">Read Mode</a> </div> --> <div class="row title"> <h1>Docker系列 7 Registry</h1> </div> <div class="row meta" datetime="2017-07-30"> <time class="col-sm-6 datetime"> <i class="fa fa-calendar" aria-hidden="true"></i> <span class="text tmargin ">July 30, 2017</span> </time> </div> <div class="row tag-list"> <i class="fa fa-tags" aria-hidden="true"></i> <a href="http://www.forbackup.tk/blog/tags//linux">linux</a> <a href="http://www.forbackup.tk/blog/tags//docker">docker</a> </div> <!-- <div class="row"> <ul id="markdown-toc"> <li><a href="#使用公共-registry" id="markdown-toc-使用公共-registry">使用公共 Registry</a></li> <li><a href="#搭建本地-registry" id="markdown-toc-搭建本地-registry">搭建本地 Registry</a> <ul> <li><a href="#启动-registry-容器" id="markdown-toc-启动-registry-容器">启动 registry 容器。</a></li> <li><a href="#通过-docker-tag-重命名镜像使之与-registry-匹配" id="markdown-toc-通过-docker-tag-重命名镜像使之与-registry-匹配">通过 docker tag 重命名镜像，使之与 registry 匹配。</a></li> <li><a href="#3-通过-docker-push-上传镜像" id="markdown-toc-3-通过-docker-push-上传镜像">3. 通过 docker push 上传镜像。</a></li> <li><a href="#4-现在已经可通过-docker-pull-从本地-registry-下载镜像了" id="markdown-toc-4-现在已经可通过-docker-pull-从本地-registry-下载镜像了">4. 现在已经可通过 docker pull 从本地 registry 下载镜像了。</a></li> <li><a href="#5-查询镜像" id="markdown-toc-5-查询镜像">5. 查询镜像</a></li> </ul> </li> <li><a href="#docker-镜像小结" id="markdown-toc-docker-镜像小结">Docker 镜像小结</a> <ul> <li><a href="#rmi" id="markdown-toc-rmi">rmi</a></li> <li><a href="#search" id="markdown-toc-search">search</a></li> </ul> </li> <li><a href="#本地安装" id="markdown-toc-本地安装">本地安装</a> <ul> <li><a href="#ubuntu" id="markdown-toc-ubuntu">Ubuntu</a></li> <li><a href="#centos" id="markdown-toc-centos">CentOS</a></li> <li><a href="#源码安装" id="markdown-toc-源码安装">源码安装</a></li> </ul> </li> <li><a href="#issue-docker-registry" id="markdown-toc-issue-docker-registry">issue (docker-registry)</a></li> <li><a href="#issue-dockerhttps" id="markdown-toc-issue-dockerhttps">issue docker(https)</a></li> <li><a href="#参考" id="markdown-toc-参考">参考</a></li> </ul> <h2 id="使用公共-registry">使用公共 Registry</h2> <p>保存和分发镜像的最直接方法就是使用 Docker Hub。</p> <p>Docker Hub 是 Docker 公司维护的公共 Registry。用户可以将自己的镜像保存到 Docker Hub 免费的 repository 中。如果不希望别人访问自己的镜像，也可以购买私有 repository。</p> <p>除了 Docker Hub，quay.io 是另一个公共 Registry，提供与 Docker Hub 类似的服务。</p> <p>下面介绍如何用 Docker Hub 存取我们的镜像。</p> <ul> <li>首先得在 Docker Hub 上注册一个账号。</li> <li>在 Docker Host 上登录。</li> <li>修改镜像的 repository 使之与 Docker Hub 账号匹配。 Docker Hub 为了区分不同用户的同名镜像，镜像的 registry 中要包含用户名，完整格式为：[username]/xxx:tag 我们通过 <code class="highlighter-rouge">docker tag</code> 命令重命名镜像。 <ul> <li> <blockquote> <p>Docker 官方自己维护的镜像没有用户名，比如 httpd。</p> </blockquote> </li> </ul> </li> <li>通过 docker push 将镜像上传到 Docker Hub。</li> </ul> <p>Docker 会上传镜像的每一层。因为 cloudman6/httpd:v1 这个镜像实际上跟官方的 httpd 镜像一模一样，Docker Hub 上已经有了全部的镜像层，所以真正上传的数据很少。同样的，如果我们的镜像是基于 base 镜像的，也只有新增加的镜像层会被上传。如果想上传同一 repository 中所有镜像，省略 tag 部分就可以了，例如：<code class="highlighter-rouge">docker push cloudman6/httpd</code></p> <ul> <li>登录 https://hub.docker.com，在Public Repository 中就可以看到上传的镜像。 如果要删除上传的镜像，只能在 Docker Hub 界面上操作。</li> <li>这个镜像可被其他 Docker host 下载使用了。</li> </ul> <h2 id="搭建本地-registry">搭建本地 Registry</h2> <p>Docker 已经将 Registry 开源了，同时在 Docker Hub 上也有官方的镜像 registry。下面我们就在 Docker 中运行自己的 registry。</p> <h3 id="启动-registry-容器">启动 registry 容器。</h3> <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker run -d -p 5000:5000 registry
</code></pre></div></div> <p>如配置镜像存储到 Amazon S3 服务</p> <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo docker run \
     -e SETTINGS_FLAVOR=s3 \
     -e AWS_BUCKET=acme-docker \
     -e STORAGE_PATH=/registry \
     -e AWS_KEY=AKIAHSHB43HS3J92MXZ \
     -e AWS_SECRET=xdDowwlK7TJajV1Y7EoOZrmuPEJlHYcNP2k4j49T \
     -e SEARCH_BACKEND=sqlalchemy \
     -p 5000:5000 \
     registry
</code></pre></div></div> <p>指定本地路径（如 /home/user/registry-conf ）下的配置文件</p> <figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="nb">sudo </span>docker run <span class="nt">-d</span> <span class="nt">-p</span> 5000:5000 <span class="nt">-v</span> /home/user/registry-conf:/registry-conf <span class="nt">-e</span> <span class="nv">DOCKER_REGISTRY_CONFIG</span><span class="o">=</span>/registry-conf/config.yml registry

docker run <span class="nt">-d</span> <span class="nt">-p</span> 5000:5000 <span class="nt">-v</span> /media/backup/dockerrepo:/var/lib/registry registry

docker run <span class="nt">-d</span> <span class="nt">-v</span> /disk2/dockrepo:/var/lib/registry <span class="nt">-p</span> 5000:5000 registry</code></pre></figure> <p>默认情况下，仓库会被创建在容器的 /var/lib/registry（v1 中是/tmp/registry）下。可以通过 <code class="highlighter-rouge">-v</code> 参数来将镜像文件存放在本地的指定路径。 例如下面的例子将上传的镜像放到 /opt/data/registry 目录。</p> <p><img src="http://www.forbackup.tk/assets/img/used/docker/registry_container.jpg" alt="start registry @x100" /></p> <p>我们使用的镜像是 registry:2。</p> <ul> <li><code class="highlighter-rouge">-d</code> 是后台启动容器。</li> <li><code class="highlighter-rouge">-p</code> 将容器的 5000 端口映射到 Host 的 5000 端口。5000 是 registry 服务端口。端口映射我们会在容器网络章节详细讨论。</li> <li><code class="highlighter-rouge">-v</code> 将容器 /var/lib/registry 目录映射到 Host 的 /myregistry，用于存放镜像数据。-v 的使用我们会在容器存储章节详细讨论。</li> </ul> <h3 id="通过-docker-tag-重命名镜像使之与-registry-匹配">通过 docker tag 重命名镜像，使之与 registry 匹配。</h3> <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker tag cloudman6/httpd:v1 registry.example.net:5000/cloudman6/httpd:v1
</code></pre></div></div> <p>我们在镜像的前面加上了运行 registry 的主机名称和端口。</p> <p>前面已经讨论了镜像名称由 repository 和 tag 两部分组成。而 repository 的完整格式为：<code class="highlighter-rouge">[registry-host]:[port]/[username]/xxx</code></p> <p>只有 Docker Hub 上的镜像可以省略 [registry-host]:[port]</p> <h3 id="3-通过-docker-push-上传镜像">3. 通过 docker push 上传镜像。</h3> <p><img src="http://www.forbackup.tk/assets/img/used/docker/docker_push_reg.jpg" alt="Docker push @x100" /></p> <h3 id="4-现在已经可通过-docker-pull-从本地-registry-下载镜像了">4. 现在已经可通过 docker pull 从本地 registry 下载镜像了。</h3> <p><img src="http://www.forbackup.tk/assets/img/used/docker/docker_pull_reg.jpg" alt="Docker pull @x100" /></p> <h3 id="5-查询镜像">5. 查询镜像</h3> <figure class="highlight"><pre><code class="language-shell" data-lang="shell">curl <span class="nt">-X</span> GET http://vickyRepo:5000/v2/_catalog</code></pre></figure> <p>除了镜像的名称长一些（包含 registry host 和 port），使用方式完全一样。</p> <p>以上是搭建本地 registry 的简要步骤。当然 registry 也支持认证，https 安全传输等特性，具体可以参考官方文档 https://docs.docker.com/registry/configuration/</p> <h2 id="docker-镜像小结">Docker 镜像小结</h2> <p>下面是镜像的常用操作子命令：</p> <ul> <li>images 显示镜像列表</li> <li>history 显示镜像构建历史</li> <li>commit 从容器创建新镜像</li> <li>build 从 Dockerfile 构建镜像</li> <li>tag 给镜像打 tag</li> <li>pull 从 registry 下载镜像</li> <li>push 将 镜像 上传到 registry</li> <li>rmi 删除 Docker host 中的镜像</li> <li>search 搜索 Docker Hub 中的镜像</li> </ul> <h3 id="rmi">rmi</h3> <p>rmi 只能删除 host 上的镜像，不会删除 registry 的镜像。</p> <p>如果一个镜像对应了多个 tag，只有当最后一个 tag 被删除时，镜像才被真正删除。例如 host 中 debian 镜像有两个 tag：</p> <p>删除其中 debian:latest 只是删除了 latest tag，镜像本身没有删除。</p> <h3 id="search">search</h3> <p>search 让我们无需打开浏览器，在命令行中就可以搜索 Docker Hub 中的镜像。</p> <p>当然，如果想知道镜像都有哪些 tag，还是得访问 Docker Hub。</p> <p>至此，Docker 镜像已经讨论完了，下节我们深入讨论容器。</p> <h2 id="本地安装">本地安装</h2> <p>Ubuntu 或 CentOS 等发行版，可以直接通过源安装。</p> <h3 id="ubuntu">Ubuntu</h3> <figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="nb">sudo </span>apt-get <span class="nb">install</span> <span class="nt">-y</span> build-essential python-dev libevent-dev python-pip liblzma-dev
<span class="nb">sudo </span>pip <span class="nb">install </span>docker-registry</code></pre></figure> <h3 id="centos">CentOS</h3> <figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="nb">sudo </span>yum <span class="nb">install</span> <span class="nt">-y</span> python-devel libevent-devel python-pip gcc xz-devel
<span class="c">#sudo python-pip install docker-registry</span>
<span class="nb">sudo </span>yum <span class="nb">install</span> <span class="nt">-y</span> swig openssl
<span class="nb">sudo </span>pip <span class="nb">install</span> <span class="nt">--upgrade</span> pip
<span class="nb">sudo </span>pip <span class="nb">install </span>docker-registry</code></pre></figure> <h3 id="源码安装">源码安装</h3> <figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="nv">$ </span><span class="nb">sudo </span>apt-get <span class="nb">install </span>build-essential python-dev libevent-dev python-pip libssl-dev liblzma-dev libffi-dev
<span class="nv">$ </span>git clone https://github.com/docker/docker-registry.git
<span class="nv">$ </span><span class="nb">cd </span>docker-registry
<span class="nv">$ </span><span class="nb">sudo </span>python setup.py <span class="nb">install</span></code></pre></figure> <p>也可从<a href="https://github.com/docker/docker-registry">docker-registry </a> 项目下载源码进行安装。</p> <p>然后修改配置文件，主要修改 dev 模板段的 storage_path 到本地的存储仓库的路径。</p> <figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="nv">$ </span><span class="nb">cp </span>config/config_sample.yml config/config.yml</code></pre></figure> <p>之后启动 Web 服务。</p> <figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="nv">$ </span><span class="nb">sudo </span>gunicorn <span class="nt">-c</span> contrib/gunicorn.py docker_registry.wsgi:application</code></pre></figure> <p>或者</p> <figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="nb">sudo </span>gunicorn <span class="nt">--access-logfile</span> - <span class="nt">--error-logfile</span> - <span class="nt">-k</span> gevent <span class="nt">-b</span> 0.0.0.0:5000 <span class="nt">-w</span> 4 <span class="nt">--max-requests</span> 100 docker_registry.wsgi:application</code></pre></figure> <p>此时使用 curl 访问本地的 5000 端口，看到输出 docker-registry 的版本信息说明运行成功。</p> <blockquote> <p>注：config/config_sample.yml 文件是示例配置文件。</p> </blockquote> <h2 id="issue-docker-registry">issue (docker-registry)</h2> <figure class="highlight"><pre><code class="language-shell" data-lang="shell">pip <span class="nb">install </span>docker-registry

Error : Unable to find <span class="s1">'openssl/opensslv.h'</span></code></pre></figure> <p>安装openssl的头文件</p> <figure class="highlight"><pre><code class="language-shell" data-lang="shell">yum <span class="nb">install </span>openssl-devel

pip <span class="nb">install </span>docker-registry

swig <span class="nt">-python</span> <span class="nt">-I</span>/usr/include/python2.7 <span class="nt">-I</span>/usr/include <span class="nt">-I</span>/usr/include/openssl <span class="nt">-includeall</span> <span class="nt">-modern</span> <span class="nt">-o</span> SWIG/_m2crypto_wrap.c SWIG/_m2crypto.i
/usr/include/openssl/opensslconf.h:36: Error: CPP <span class="c">#error ""This openssl-devel package does not work your architecture?"". Use the -cpperraswarn option to continue swig processing.</span></code></pre></figure> <p>查看一下安装的文件是否x86和x64位的头文件都有</p> <figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="nb">ls</span> /usr/include/openssl/</code></pre></figure> <figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="cp">#include "opensslconf-sparc.h"
#elif defined(__x86_64__)
#include "opensslconf-x86_64.h"    #原来是这样写的，说明默认去找x86_64位的头文件
#else
#error "This openssl-devel package does not work your architecture?"
#endif
</span> 
<span class="cp">#undef openssl_opensslconf_multilib_redirection_h   </span></code></pre></figure> <p><br /> 默认去找x86_64位的头文件报了错，那就说明希望去找x86的文件了，修改方法如下</p> <figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="cp">#include "opensslconf-sparc.h"
#elif defined(__x86_64__)
#include "opensslconf-x86_64.h"    #原来是这样写的，说明默认去找x86_64位的头文件
#else
#include "opensslconf.h"     #去掉了原来的error提示，改成了安装opensslconf.h文件。
#endif
</span> 
<span class="cp">#undef openssl_opensslconf_multilib_redirection_h   </span></code></pre></figure> <p>再次运行</p> <figure class="highlight"><pre><code class="language-shell" data-lang="shell">pip <span class="nb">install </span>docker-registry</code></pre></figure> <h2 id="issue-dockerhttps">issue docker(https)</h2> <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># docker push 192.168.1.108:5000/reg:init
The push refers to a repository [192.168.1.108:5000/reg]
Get https://192.168.1.108:5000/v1/_ping: http: server gave HTTP response to HTTPS client
</code></pre></div></div> <p>解决：</p> <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Create or modify /etc/docker/daemon.json on the client machine

{ "insecure-registries":["myregistry.example.com:5000"] }
Restart docker daemon

sudo /etc/init.d/docker restart
</code></pre></div></div> <p>If you are using Windows and you get this error you need to create a file here:</p> <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>"C:\ProgramData\docker\config\daemon.json"  
{ "insecure-registries":["myregistry.example.com:5000"] }
</code></pre></div></div> <h2 id="参考">参考</h2> <ul> <li><a href="https://my.oschina.net/lionel45/blog/664017">error: command ‘swig’ failed with exit status 1</a></li> <li><a href="https://docs.docker.com/registry/spec/api/">registry API</a></li> <li><a href="https://docs.docker.com/registry/configuration/">官方文档</a></li> </ul> 6106 </div> --> <div class="row content"> <ul id="markdown-toc"> <li><a href="#使用公共-registry" id="markdown-toc-使用公共-registry">使用公共 Registry</a></li> <li><a href="#搭建本地-registry" id="markdown-toc-搭建本地-registry">搭建本地 Registry</a> <ul> <li><a href="#启动-registry-容器" id="markdown-toc-启动-registry-容器">启动 registry 容器。</a></li> <li><a href="#通过-docker-tag-重命名镜像使之与-registry-匹配" id="markdown-toc-通过-docker-tag-重命名镜像使之与-registry-匹配">通过 docker tag 重命名镜像，使之与 registry 匹配。</a></li> <li><a href="#3-通过-docker-push-上传镜像" id="markdown-toc-3-通过-docker-push-上传镜像">3. 通过 docker push 上传镜像。</a></li> <li><a href="#4-现在已经可通过-docker-pull-从本地-registry-下载镜像了" id="markdown-toc-4-现在已经可通过-docker-pull-从本地-registry-下载镜像了">4. 现在已经可通过 docker pull 从本地 registry 下载镜像了。</a></li> <li><a href="#5-查询镜像" id="markdown-toc-5-查询镜像">5. 查询镜像</a></li> </ul> </li> <li><a href="#docker-镜像小结" id="markdown-toc-docker-镜像小结">Docker 镜像小结</a> <ul> <li><a href="#rmi" id="markdown-toc-rmi">rmi</a></li> <li><a href="#search" id="markdown-toc-search">search</a></li> </ul> </li> <li><a href="#本地安装" id="markdown-toc-本地安装">本地安装</a> <ul> <li><a href="#ubuntu" id="markdown-toc-ubuntu">Ubuntu</a></li> <li><a href="#centos" id="markdown-toc-centos">CentOS</a></li> <li><a href="#源码安装" id="markdown-toc-源码安装">源码安装</a></li> </ul> </li> <li><a href="#issue-docker-registry" id="markdown-toc-issue-docker-registry">issue (docker-registry)</a></li> <li><a href="#issue-dockerhttps" id="markdown-toc-issue-dockerhttps">issue docker(https)</a></li> <li><a href="#参考" id="markdown-toc-参考">参考</a></li> </ul> <h2 id="使用公共-registry">使用公共 Registry</h2> <p>保存和分发镜像的最直接方法就是使用 Docker Hub。</p> <p>Docker Hub 是 Docker 公司维护的公共 Registry。用户可以将自己的镜像保存到 Docker Hub 免费的 repository 中。如果不希望别人访问自己的镜像，也可以购买私有 repository。</p> <p>除了 Docker Hub，quay.io 是另一个公共 Registry，提供与 Docker Hub 类似的服务。</p> <p>下面介绍如何用 Docker Hub 存取我们的镜像。</p> <ul> <li>首先得在 Docker Hub 上注册一个账号。</li> <li>在 Docker Host 上登录。</li> <li>修改镜像的 repository 使之与 Docker Hub 账号匹配。 Docker Hub 为了区分不同用户的同名镜像，镜像的 registry 中要包含用户名，完整格式为：[username]/xxx:tag 我们通过 <code class="highlighter-rouge">docker tag</code> 命令重命名镜像。 <ul> <li> <blockquote> <p>Docker 官方自己维护的镜像没有用户名，比如 httpd。</p> </blockquote> </li> </ul> </li> <li>通过 docker push 将镜像上传到 Docker Hub。</li> </ul> <p>Docker 会上传镜像的每一层。因为 cloudman6/httpd:v1 这个镜像实际上跟官方的 httpd 镜像一模一样，Docker Hub 上已经有了全部的镜像层，所以真正上传的数据很少。同样的，如果我们的镜像是基于 base 镜像的，也只有新增加的镜像层会被上传。如果想上传同一 repository 中所有镜像，省略 tag 部分就可以了，例如：<code class="highlighter-rouge">docker push cloudman6/httpd</code></p> <ul> <li>登录 https://hub.docker.com，在Public Repository 中就可以看到上传的镜像。 如果要删除上传的镜像，只能在 Docker Hub 界面上操作。</li> <li>这个镜像可被其他 Docker host 下载使用了。</li> </ul> <h2 id="搭建本地-registry">搭建本地 Registry</h2> <p>Docker 已经将 Registry 开源了，同时在 Docker Hub 上也有官方的镜像 registry。下面我们就在 Docker 中运行自己的 registry。</p> <h3 id="启动-registry-容器">启动 registry 容器。</h3> <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker run -d -p 5000:5000 registry
</code></pre></div></div> <p>如配置镜像存储到 Amazon S3 服务</p> <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo docker run \
     -e SETTINGS_FLAVOR=s3 \
     -e AWS_BUCKET=acme-docker \
     -e STORAGE_PATH=/registry \
     -e AWS_KEY=AKIAHSHB43HS3J92MXZ \
     -e AWS_SECRET=xdDowwlK7TJajV1Y7EoOZrmuPEJlHYcNP2k4j49T \
     -e SEARCH_BACKEND=sqlalchemy \
     -p 5000:5000 \
     registry
</code></pre></div></div> <p>指定本地路径（如 /home/user/registry-conf ）下的配置文件</p> <figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="nb">sudo </span>docker run <span class="nt">-d</span> <span class="nt">-p</span> 5000:5000 <span class="nt">-v</span> /home/user/registry-conf:/registry-conf <span class="nt">-e</span> <span class="nv">DOCKER_REGISTRY_CONFIG</span><span class="o">=</span>/registry-conf/config.yml registry

docker run <span class="nt">-d</span> <span class="nt">-p</span> 5000:5000 <span class="nt">-v</span> /media/backup/dockerrepo:/var/lib/registry registry

docker run <span class="nt">-d</span> <span class="nt">-v</span> /disk2/dockrepo:/var/lib/registry <span class="nt">-p</span> 5000:5000 registry</code></pre></figure> <p>默认情况下，仓库会被创建在容器的 /var/lib/registry（v1 中是/tmp/registry）下。可以通过 <code class="highlighter-rouge">-v</code> 参数来将镜像文件存放在本地的指定路径。 例如下面的例子将上传的镜像放到 /opt/data/registry 目录。</p> <p><img src="http://www.forbackup.tk/assets/img/used/docker/registry_container.jpg" alt="start registry @x100" /></p> <p>我们使用的镜像是 registry:2。</p> <ul> <li><code class="highlighter-rouge">-d</code> 是后台启动容器。</li> <li><code class="highlighter-rouge">-p</code> 将容器的 5000 端口映射到 Host 的 5000 端口。5000 是 registry 服务端口。端口映射我们会在容器网络章节详细讨论。</li> <li><code class="highlighter-rouge">-v</code> 将容器 /var/lib/registry 目录映射到 Host 的 /myregistry，用于存放镜像数据。-v 的使用我们会在容器存储章节详细讨论。</li> </ul> <h3 id="通过-docker-tag-重命名镜像使之与-registry-匹配">通过 docker tag 重命名镜像，使之与 registry 匹配。</h3> <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker tag cloudman6/httpd:v1 registry.example.net:5000/cloudman6/httpd:v1
</code></pre></div></div> <p>我们在镜像的前面加上了运行 registry 的主机名称和端口。</p> <p>前面已经讨论了镜像名称由 repository 和 tag 两部分组成。而 repository 的完整格式为：<code class="highlighter-rouge">[registry-host]:[port]/[username]/xxx</code></p> <p>只有 Docker Hub 上的镜像可以省略 [registry-host]:[port]</p> <h3 id="3-通过-docker-push-上传镜像">3. 通过 docker push 上传镜像。</h3> <p><img src="http://www.forbackup.tk/assets/img/used/docker/docker_push_reg.jpg" alt="Docker push @x100" /></p> <h3 id="4-现在已经可通过-docker-pull-从本地-registry-下载镜像了">4. 现在已经可通过 docker pull 从本地 registry 下载镜像了。</h3> <p><img src="http://www.forbackup.tk/assets/img/used/docker/docker_pull_reg.jpg" alt="Docker pull @x100" /></p> <h3 id="5-查询镜像">5. 查询镜像</h3> <figure class="highlight"><pre><code class="language-shell" data-lang="shell">curl <span class="nt">-X</span> GET http://vickyRepo:5000/v2/_catalog</code></pre></figure> <p>除了镜像的名称长一些（包含 registry host 和 port），使用方式完全一样。</p> <p>以上是搭建本地 registry 的简要步骤。当然 registry 也支持认证，https 安全传输等特性，具体可以参考官方文档 https://docs.docker.com/registry/configuration/</p> <h2 id="docker-镜像小结">Docker 镜像小结</h2> <p>下面是镜像的常用操作子命令：</p> <ul> <li>images 显示镜像列表</li> <li>history 显示镜像构建历史</li> <li>commit 从容器创建新镜像</li> <li>build 从 Dockerfile 构建镜像</li> <li>tag 给镜像打 tag</li> <li>pull 从 registry 下载镜像</li> <li>push 将 镜像 上传到 registry</li> <li>rmi 删除 Docker host 中的镜像</li> <li>search 搜索 Docker Hub 中的镜像</li> </ul> <h3 id="rmi">rmi</h3> <p>rmi 只能删除 host 上的镜像，不会删除 registry 的镜像。</p> <p>如果一个镜像对应了多个 tag，只有当最后一个 tag 被删除时，镜像才被真正删除。例如 host 中 debian 镜像有两个 tag：</p> <p>删除其中 debian:latest 只是删除了 latest tag，镜像本身没有删除。</p> <h3 id="search">search</h3> <p>search 让我们无需打开浏览器，在命令行中就可以搜索 Docker Hub 中的镜像。</p> <p>当然，如果想知道镜像都有哪些 tag，还是得访问 Docker Hub。</p> <p>至此，Docker 镜像已经讨论完了，下节我们深入讨论容器。</p> <h2 id="本地安装">本地安装</h2> <p>Ubuntu 或 CentOS 等发行版，可以直接通过源安装。</p> <h3 id="ubuntu">Ubuntu</h3> <figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="nb">sudo </span>apt-get <span class="nb">install</span> <span class="nt">-y</span> build-essential python-dev libevent-dev python-pip liblzma-dev
<span class="nb">sudo </span>pip <span class="nb">install </span>docker-registry</code></pre></figure> <h3 id="centos">CentOS</h3> <figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="nb">sudo </span>yum <span class="nb">install</span> <span class="nt">-y</span> python-devel libevent-devel python-pip gcc xz-devel
<span class="c">#sudo python-pip install docker-registry</span>
<span class="nb">sudo </span>yum <span class="nb">install</span> <span class="nt">-y</span> swig openssl
<span class="nb">sudo </span>pip <span class="nb">install</span> <span class="nt">--upgrade</span> pip
<span class="nb">sudo </span>pip <span class="nb">install </span>docker-registry</code></pre></figure> <h3 id="源码安装">源码安装</h3> <figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="nv">$ </span><span class="nb">sudo </span>apt-get <span class="nb">install </span>build-essential python-dev libevent-dev python-pip libssl-dev liblzma-dev libffi-dev
<span class="nv">$ </span>git clone https://github.com/docker/docker-registry.git
<span class="nv">$ </span><span class="nb">cd </span>docker-registry
<span class="nv">$ </span><span class="nb">sudo </span>python setup.py <span class="nb">install</span></code></pre></figure> <p>也可从<a href="https://github.com/docker/docker-registry">docker-registry </a> 项目下载源码进行安装。</p> <p>然后修改配置文件，主要修改 dev 模板段的 storage_path 到本地的存储仓库的路径。</p> <figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="nv">$ </span><span class="nb">cp </span>config/config_sample.yml config/config.yml</code></pre></figure> <p>之后启动 Web 服务。</p> <figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="nv">$ </span><span class="nb">sudo </span>gunicorn <span class="nt">-c</span> contrib/gunicorn.py docker_registry.wsgi:application</code></pre></figure> <p>或者</p> <figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="nb">sudo </span>gunicorn <span class="nt">--access-logfile</span> - <span class="nt">--error-logfile</span> - <span class="nt">-k</span> gevent <span class="nt">-b</span> 0.0.0.0:5000 <span class="nt">-w</span> 4 <span class="nt">--max-requests</span> 100 docker_registry.wsgi:application</code></pre></figure> <p>此时使用 curl 访问本地的 5000 端口，看到输出 docker-registry 的版本信息说明运行成功。</p> <blockquote> <p>注：config/config_sample.yml 文件是示例配置文件。</p> </blockquote> <h2 id="issue-docker-registry">issue (docker-registry)</h2> <figure class="highlight"><pre><code class="language-shell" data-lang="shell">pip <span class="nb">install </span>docker-registry

Error : Unable to find <span class="s1">'openssl/opensslv.h'</span></code></pre></figure> <p>安装openssl的头文件</p> <figure class="highlight"><pre><code class="language-shell" data-lang="shell">yum <span class="nb">install </span>openssl-devel

pip <span class="nb">install </span>docker-registry

swig <span class="nt">-python</span> <span class="nt">-I</span>/usr/include/python2.7 <span class="nt">-I</span>/usr/include <span class="nt">-I</span>/usr/include/openssl <span class="nt">-includeall</span> <span class="nt">-modern</span> <span class="nt">-o</span> SWIG/_m2crypto_wrap.c SWIG/_m2crypto.i
/usr/include/openssl/opensslconf.h:36: Error: CPP <span class="c">#error ""This openssl-devel package does not work your architecture?"". Use the -cpperraswarn option to continue swig processing.</span></code></pre></figure> <p>查看一下安装的文件是否x86和x64位的头文件都有</p> <figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="nb">ls</span> /usr/include/openssl/</code></pre></figure> <figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="cp">#include "opensslconf-sparc.h"
#elif defined(__x86_64__)
#include "opensslconf-x86_64.h"    #原来是这样写的，说明默认去找x86_64位的头文件
#else
#error "This openssl-devel package does not work your architecture?"
#endif
</span> 
<span class="cp">#undef openssl_opensslconf_multilib_redirection_h   </span></code></pre></figure> <p><br /> 默认去找x86_64位的头文件报了错，那就说明希望去找x86的文件了，修改方法如下</p> <figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="cp">#include "opensslconf-sparc.h"
#elif defined(__x86_64__)
#include "opensslconf-x86_64.h"    #原来是这样写的，说明默认去找x86_64位的头文件
#else
#include "opensslconf.h"     #去掉了原来的error提示，改成了安装opensslconf.h文件。
#endif
</span> 
<span class="cp">#undef openssl_opensslconf_multilib_redirection_h   </span></code></pre></figure> <p>再次运行</p> <figure class="highlight"><pre><code class="language-shell" data-lang="shell">pip <span class="nb">install </span>docker-registry</code></pre></figure> <h2 id="issue-dockerhttps">issue docker(https)</h2> <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># docker push 192.168.1.108:5000/reg:init
The push refers to a repository [192.168.1.108:5000/reg]
Get https://192.168.1.108:5000/v1/_ping: http: server gave HTTP response to HTTPS client
</code></pre></div></div> <p>解决：</p> <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Create or modify /etc/docker/daemon.json on the client machine

{ "insecure-registries":["myregistry.example.com:5000"] }
Restart docker daemon

sudo /etc/init.d/docker restart
</code></pre></div></div> <p>If you are using Windows and you get this error you need to create a file here:</p> <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>"C:\ProgramData\docker\config\daemon.json"  
{ "insecure-registries":["myregistry.example.com:5000"] }
</code></pre></div></div> <h2 id="参考">参考</h2> <ul> <li><a href="https://my.oschina.net/lionel45/blog/664017">error: command ‘swig’ failed with exit status 1</a></li> <li><a href="https://docs.docker.com/registry/spec/api/">registry API</a></li> <li><a href="https://docs.docker.com/registry/configuration/">官方文档</a></li> </ul> <div class="col-sm-2 image pull-right"> <img class="avatar-img avata" style='border="0";border-radius: 50%' src="http://www.forbackup.tk/assets/img/author/blog.svg" alt="" height="32px" width="32px"> </div> </div> <ul class="pager"> <li><a href="/docker_col/2017/07/30/docker-learn-06.html">Docker系列 6 镜像命名的最佳实践</a></li> <li><a href="/docker_col/2017/08/05/docker-learn-08.html">Docker系列 8 如何运行容器？</a></li> </ul> </article> </div> </div> </div> <div class="footer"> <div class="container-fluid"> <div class="row-fluid"> <div class="col-sm-4 copyright"> <span>Vicky's Blog © 2018 • All right reserved.</span> </div> <div class="col-sm-4 message"> <span>Simplicity is fashionable.</span> </div> <div class="col-sm-4 madeby"> <span>Made with&nbsp;<a href="https://jekyllrb.com" target="_blank">Jekyll</a>&nbsp;by&nbsp;Vicky.</span> </div> <a class="pull-right top" href="#top"><i class="fa fa-caret-up" aria-hidden="true"></i></a> </div> </div> </div> </div> <!-- Vendor - Global | Applicable to every website --> <!-- #### VENDOR OFFLINE #### --> <script src="http://www.forbackup.tk/assets/vendor-off/jquery/js/jquery.min.js"></script> <script src="http://www.forbackup.tk/assets/vendor-off/bootstrap/js/bootstrap.min.js"></script> <script defer src="http://www.forbackup.tk/assets/vendor-off/font-awesome/svg-with-js/js/fontawesome-all.min.js"></script> <script src="http://www.forbackup.tk/assets/javascripts/jekyll-spotify-plugin.min.js"></script> <!-- Specific for each pages. --> <script type="text/javascript" src="http://www.forbackup.tk/assets/javascripts/post.js"></script> <!-- Add 'ga' function from Google Analytics to certain site links in Posts --> <!-- App | Global --> <script src="http://www.forbackup.tk/assets/javascripts/global.js"></script> </body> </html>




    



<!-- Include Data Base --> <!DOCTYPE html> <html lang="en" itemscope itemtype="http://schema.org/WebPage"> <head> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title>Docker系列 8 如何运行容器？ | Vicky's Blog </title> <meta name=description content=""> <meta name="robots" content="index, follow"> <meta name=viewport content="width=device-width, initial-scale=1"> <meta http-equiv="cache-control" content="public"/> <meta http-equiv="pragma" content="public"> <meta name="keywords" content="Theme, Jekyll" /> <meta name="author" content="" /> <meta property="og:locale" content="en" /> <meta property="og:site_name" content="Vicky's Blog" /> <meta property="og:type" content="WebSite" /> <meta property="og:url" content="http://www.forbackup.tk/docker_col/2017/08/05/docker-learn-08.html" /> <meta property="og:description" content="" /> <meta property="og:title" content="Docker系列 8 如何运行容器？ - Vicky's Blog" /> <link rel="canonical" href="http://www.forbackup.tk/docker_col/2017/08/05/docker-learn-08.html"> <link rel="alternate" type="application/rss+xml" title="Vicky's Blog" href="http://www.forbackup.tk/feed.xml"> <script type="application/ld+json"> {"@context": "http://schema.org", "@type": "WebSite", "name": "", "headline": "Vicky's Blog", "author": {"@type": "Person", "name": {"Vicky's Blog"}}, "description": "", "url": "http://www.forbackup.tk"} </script> <script type="text/javascript"> var GLOBAL_BASEURL = "http://www.forbackup.tk"; </script> <link rel="icon" type="image/png" sizes="16x16" href="http://www.forbackup.tk/assets/img/favicon/favicon-16x16.png"> <!-- #### VENDOR OFFLINE #### --> <!-- Bootstrap 3.3.6 - Offline --> <link rel="stylesheet" href="http://www.forbackup.tk/assets/vendor-off/bootstrap/css/bootstrap.min.css"> <!-- Font Awesome 5.03 - Offline --> <script defer src="http://www.forbackup.tk/assets/vendor-off/font-awesome/web-fonts-with-css/css/fontawesome-all.min.css"></script> <link rel="stylesheet" href="http://www.forbackup.tk/assets/vendor-off/fonts/space-mono/space-mono.min.css"> <link rel="stylesheet" href="http://www.forbackup.tk/assets/vendor-off/fonts/gloria-hallelujah/gloria-hallelujah.min.css"> <!-- Style Default --> <link rel="stylesheet" href="http://www.forbackup.tk/assets/stylesheets/main.css"> <!-- Google Analytics --> </head> <body> <div class="main" id="top"> <div class="container wrapper"> <div class="row"> <div class="col-sm-3 sidebar"> <div class="row avatar"> <a href="http://www.forbackup.tk/"> <img class="img-responsive center-block avatar-img" src="http://www.forbackup.tk/assets/img/avatar/blog.svg" height="165" width="165" alt="Vicky's Blog"> </a> </div> <div class="row header"> <h2><a href="http://www.forbackup.tk/">Vicky </a></h2> </div> <div class="row menu"> <ul> <li> <i class="fa fa-home" aria-hidden="true"></i>&nbsp;<a href="http://www.forbackup.tk/">Home</a> </li> <hr class="breakline"> <li class="li-folder-open"> <i style="font-size: ;" class="fas fa-folder-open"></i>&nbsp;<a class="unlink">Blog</a> </li> <li class="li-fa-edit"> <i style="font-size: ;" class="fas fa-edit" aria-hidden="true"></i>&nbsp;<a href="http://www.forbackup.tk/general/" >General</a> </li> <li class="li-fa-docker"> <i style="font-size: ;" class="fab fa-docker" aria-hidden="true"></i>&nbsp;<a href="http://www.forbackup.tk/docker_col/" >Docker</a> </li> <li class="li-fa-table"> <i style="font-size: ;" class="fas fa-table" aria-hidden="true"></i>&nbsp;<a href="http://www.forbackup.tk/data_analysis/" >Data Analysis</a> </li> <li class="li-fa-tags"> <i style="font-size: ;" class="fas fa-tags" aria-hidden="true"></i>&nbsp;<a href="http://www.forbackup.tk/blog/tags/" >Tags</a> </li> <li class="li-fa-briefcase"> <i style="font-size: ;" class="fas fa-briefcase" aria-hidden="true"></i>&nbsp;<a href="http://www.forbackup.tk/blog/projects/" >Projects</a> </li> </ul> <div class="socials"> <div class="row"> <p></p> <p></p> </div> </div> </div> </div> <div class="col-sm-9 content-main"> <!-- Include Data Base --> <article class="post" itemscope itemtype="http://schema.org/BlogPosting"> <!-- Next Version <div class="readmode"> <a id="btn-readmode" class="pull-right btn btn-default btn-readmode" href="">Read Mode</a> </div> --> <div class="row title"> <h1>Docker系列 8 如何运行容器？</h1> </div> <div class="row meta" datetime="2017-08-05"> <time class="col-sm-6 datetime"> <i class="fa fa-calendar" aria-hidden="true"></i> <span class="text tmargin ">August 05, 2017</span> </time> </div> <div class="row tag-list"> <i class="fa fa-tags" aria-hidden="true"></i> <a href="http://www.forbackup.tk/blog/tags//linux">linux</a> <a href="http://www.forbackup.tk/blog/tags//docker">docker</a> </div> <!-- <div class="row"> <ul id="markdown-toc"> <li><a href="#运行容器" id="markdown-toc-运行容器">运行容器</a></li> <li><a href="#让容器长期运行" id="markdown-toc-让容器长期运行">让容器长期运行</a></li> <li><a href="#两种进入容器的方法" id="markdown-toc-两种进入容器的方法">两种进入容器的方法</a> <ul> <li><a href="#docker-attach" id="markdown-toc-docker-attach">docker attach</a></li> <li><a href="#docker-exec" id="markdown-toc-docker-exec">docker exec</a></li> <li><a href="#attach-vs-exec" id="markdown-toc-attach-vs-exec">attach VS exec</a></li> </ul> </li> <li><a href="#运行容器的最佳实践" id="markdown-toc-运行容器的最佳实践">运行容器的最佳实践</a> <ul> <li><a href="#容器运行小结" id="markdown-toc-容器运行小结">容器运行小结</a></li> </ul> </li> </ul> <h2 id="运行容器">运行容器</h2> <p><code class="highlighter-rouge">docker run</code> 是启动容器的方法。在讨论 Dockerfile 时我们已经学习到，可用三种方式指定容器启动时执行的命令：</p> <ul> <li><code class="highlighter-rouge">CMD</code> 指令。</li> <li><code class="highlighter-rouge">ENDPOINT</code> 指令。</li> <li>在 <code class="highlighter-rouge">docker run</code> 命令行中指定。</li> </ul> <p>例如下面的例子：</p> <figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="o">[</span>root@dockerserver ~]# docker run centos <span class="nb">pwd</span>
/
<span class="o">[</span>root@dockerserver ~]# </code></pre></figure> <p>容器启动时执行 <code class="highlighter-rouge">pwd</code>，返回的 <code class="highlighter-rouge">/</code> 是容器中的当前目录。 执行 <code class="highlighter-rouge">docker ps</code> 或 <code class="highlighter-rouge">docker container ls</code> 可以查看 <code class="highlighter-rouge">Docker host</code> 中当前运行的容器：</p> <figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="o">[</span>root@dockerserver ~]# docker ps
CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES
<span class="o">[</span>root@dockerserver ~]# docker container <span class="nb">ls
</span>CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES

<span class="o">[</span>root@dockerserver ~]# docker ps <span class="nt">-a</span>
CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS                     PORTS               NAMES
e0be46060424        centos              <span class="s2">"pwd"</span>               3 minutes ago       Exited <span class="o">(</span>0<span class="o">)</span> 3 minutes ago 

<span class="o">[</span>root@dockerserver ~]# docker container <span class="nb">ls</span> <span class="nt">-a</span>
CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS                     PORTS               NAMES
e0be46060424        centos              <span class="s2">"pwd"</span>               3 minutes ago       Exited <span class="o">(</span>0<span class="o">)</span> 3 minutes ago                     
<span class="o">[</span>root@dockerserver ~]# </code></pre></figure> <p><code class="highlighter-rouge">-a</code> 会显示所有状态的容器，可以看到，之前的容器已经退出了，状态为Exited。</p> <h2 id="让容器长期运行">让容器长期运行</h2> <p>容器的生命周期依赖于启动时执行的命令，只要该命令不结束，容器也就不会退出。</p> <p>理解了这个原理，我们就可以通过执行一个长期运行的命令来保持容器的运行状态。例如执行下面的命令：</p> <figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="nv">$ </span>docker run centos /bin/bash <span class="nt">-c</span> <span class="s2">"while true; do sleep 1; done"</span>

<span class="nv">$ </span>docker ps
CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS               NAMES
eecca9576653        centos              <span class="s2">"/bin/bash -c 'whi..."</span>   44 seconds ago      Up 44 seconds  </code></pre></figure> <p><code class="highlighter-rouge">while</code> 语句让 bash 不会退出。不过这种方法有个缺点：它占用了一个终端。</p> <p>可以加上参数 -d 以后台方式启动容器。</p> <figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="nv">$ </span>docker run <span class="nt">-d</span> centos /bin/bash <span class="nt">-c</span> <span class="s2">"while true; do sleep 1; done"</span>
71cc983f0be3be4188edc861269ae05057ae070a8e0c210db71a48541bad8d54
<span class="nv">$ </span>docker ps
CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS               NAMES
71cc983f0be3        centos              <span class="s2">"/bin/bash -c 'whi..."</span>   6 seconds ago       Up 5 seconds                            romantic_wiles</code></pre></figure> <p>CONTAINER ID 是容器的 “短ID”，前面启动容器时返回的是 “长ID”。短ID是长ID的前12个字符。</p> <p><code class="highlighter-rouge">NAMES</code> 字段显示容器的名字，在启动容器时可以通过 <code class="highlighter-rouge">--name</code> 参数显示地为容器命名，如果不指定，docker 会自动为容器分配名字。</p> <p>对于容器的后续操作，我们需要通过 “长ID”、“短ID” 或者 “名称” 来指定要操作的容器。 比如停止一个容器：</p> <figure class="highlight"><pre><code class="language-shell" data-lang="shell">docker stop 71cc983f0be3</code></pre></figure> <p>容器常见的用途是运行后台服务，例如前面我们已经看到的 http server</p> <figure class="highlight"><pre><code class="language-shell" data-lang="shell">docker run <span class="nt">--name</span> myhttp <span class="nt">-d</span> httpd
docker <span class="nb">history </span>httpd</code></pre></figure> <p>这一次我们用 <code class="highlighter-rouge">--name</code> 指定了容器的名字。 我们还看到容器运行的命令是httpd-foreground，通过 docker history 可知这个命令是通过 CMD 指定的。</p> <figure class="highlight"><pre><code class="language-shell" data-lang="shell">docker run <span class="nt">--name</span> myhttp <span class="nt">-d</span> httpd
Unable to find image <span class="s1">'httpd:latest'</span> locally
latest: Pulling from library/httpd
9f0706ba7422: Downloading <span class="o">[==============&gt;</span>                                    <span class="o">]</span> 15.68 MB/52.61 MB
9f0706ba7422: Pull <span class="nb">complete 
</span>47bacf36113f: Pull <span class="nb">complete 
</span>56798d8e5a30: Pull <span class="nb">complete 
</span>94b25413538a: Pull <span class="nb">complete 
</span>97d879f4e260: Pull <span class="nb">complete 
</span>2a4f7e960a3e: Pull <span class="nb">complete 
</span>12f5eb531290: Pull <span class="nb">complete 
</span>Digest: sha256:8f58a3ef340038615498cead8b83fa3b31e4fe5c16961c6c3635e973ac9303ed
Status: Downloaded newer image <span class="k">for </span>httpd:latest
a088fcb283345b36f17a679a326d1507d300e07f5a3c00123613afc055c12e0c


docker ps
CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS               NAMES
a088fcb28334        httpd               <span class="s2">"httpd-foreground"</span>       8 minutes ago       Up 8 minutes        80/tcp              myhttp
71cc983f0be3        centos              <span class="s2">"/bin/bash -c 'whi..."</span>   40 minutes ago      Up 40 minutes                           romantic_wiles


docker <span class="nb">history </span>httpd
IMAGE               CREATED             CREATED BY                                      SIZE                COMMENT
b1e597b50dd7        7 days ago          /bin/sh <span class="nt">-c</span> <span class="c">#(nop)  CMD ["httpd-foreground"]     0 B</span>
&lt;missing&gt;           7 days ago          /bin/sh <span class="nt">-c</span> <span class="c">#(nop)  EXPOSE 80/tcp                0 B</span>
&lt;missing&gt;           7 days ago          /bin/sh <span class="nt">-c</span> <span class="c">#(nop) COPY file:761e313354b918...   133 B</span>
&lt;missing&gt;           7 days ago          /bin/sh <span class="nt">-c</span> <span class="nb">set</span> <span class="nt">-x</span>  <span class="o">&amp;&amp;</span> <span class="nv">buildDeps</span><span class="o">=</span><span class="s2">"   bzip2 ...   9.68 MB
&lt;missing&gt;           7 days ago          /bin/sh -c #(nop)  ENV HTTPD_ASC_URL=https...   0 B 
&lt;missing&gt;           7 days ago          /bin/sh -c #(nop)  ENV HTTPD_BZ2_URL=https...   0 B
&lt;missing&gt;           7 days ago          /bin/sh -c #(nop)  ENV HTTPD_SHA1=bd6d138c...   0 B
&lt;missing&gt;           7 days ago          /bin/sh -c #(nop)  ENV HTTPD_VERSION=2.4.25     0 B
&lt;missing&gt;           7 days ago          /bin/sh -c apt-get update  &amp;&amp; apt-get inst...   44.2 MB
&lt;missing&gt;           7 days ago          /bin/sh -c {   echo 'deb http://deb.debian...   161 B
&lt;missing&gt;           7 days ago          /bin/sh -c #(nop)  ENV OPENSSL_VERSION=1.0...   0 B
&lt;missing&gt;           7 days ago          /bin/sh -c #(nop)  ENV NGHTTP2_VERSION=1.1...   0 B
&lt;missing&gt;           7 days ago          /bin/sh -c #(nop) WORKDIR /usr/local/apache2    0 B
&lt;missing&gt;           7 days ago          /bin/sh -c mkdir -p "</span><span class="nv">$HTTPD_PREFIX</span><span class="s2">"  &amp;&amp; ch...   0 B
&lt;missing&gt;           7 days ago          /bin/sh -c #(nop)  ENV PATH=/usr/local/apa...   0 B
&lt;missing&gt;           7 days ago          /bin/sh -c #(nop)  ENV HTTPD_PREFIX=/usr/l...   0 B
&lt;missing&gt;           9 days ago          /bin/sh -c echo 'deb http://deb.debian.org...   55 B
&lt;missing&gt;           9 days ago          /bin/sh -c #(nop)  CMD ["</span>bash<span class="s2">"]                 0 B
&lt;missing&gt;           9 days ago          /bin/sh -c #(nop) ADD file:9c48682ff75c756...   123 MB     </span></code></pre></figure> <h2 id="两种进入容器的方法">两种进入容器的方法</h2> <p>我们经常需要进到容器里去做一些工作，比如查看日志、调试、启动其他进程等。有两种方法进入容器：<code class="highlighter-rouge">attach</code> 和 <code class="highlighter-rouge">exec</code>。</p> <h3 id="docker-attach">docker attach</h3> <p>通过 docker attach 可以 attach 到容器启动命令的终端，例如：</p> <figure class="highlight"><pre><code class="language-shell" data-lang="shell">docker ps
CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS               NAMES
e787420eca98        centos              <span class="s2">"/bin/bash -c 'whi..."</span>   9 seconds ago       Up 8 seconds                            elegant_hawking
<span class="o">[</span>root@dockerclient docker]# docker attach e7874</code></pre></figure> <blockquote> <p>注：可通过 Ctrl+p 然后 Ctrl+q 组合键退出 attach 终端。</p> </blockquote> <h3 id="docker-exec">docker exec</h3> <p>通过 <code class="highlighter-rouge">docker exec</code> 进入相同的容器：</p> <figure class="highlight"><pre><code class="language-shell" data-lang="shell">docker <span class="nb">exec</span> <span class="nt">-it</span> e7874 bash</code></pre></figure> <p>说明如下：</p> <ol> <li><code class="highlighter-rouge">-it</code> 以交互模式打开 pseudo-TTY，执行 bash，其结果就是打开了一个 bash 终端。</li> <li>进入到容器中，容器的 hostname 就是其 “短ID”。</li> <li>可以像在普通 Linux 中一样执行命令。<code class="highlighter-rouge">ps -elf</code> 显示了容器启动进程while 以及当前的 bash 进程。</li> <li>执行 exit 退出容器，回到 docker host。</li> </ol> <figure class="highlight"><pre><code class="language-shell" data-lang="shell">docker <span class="nb">exec</span> <span class="nt">-it</span> &lt;container&gt; bash|sh 是执行 <span class="nb">exec </span>最常用的方式。</code></pre></figure> <h3 id="attach-vs-exec">attach VS exec</h3> <p>attach 与 exec 主要区别如下:</p> <ul> <li><code class="highlighter-rouge">attach</code> 直接进入容器 <strong>启动命令</strong> 的终端，不会启动新的进程。</li> <li><code class="highlighter-rouge">exec</code> 则是在容器中打开新的终端，并且可以启动新的进程。</li> <li>如果想直接在终端中查看启动命令的输出，用 <code class="highlighter-rouge">attach</code>；其他情况使用 <code class="highlighter-rouge">exec</code>。</li> </ul> <p>查看启动命令输出，使用 <code class="highlighter-rouge">docker logs</code></p> <figure class="highlight"><pre><code class="language-shell" data-lang="shell">docker logs <span class="nt">-f</span> 1328d892ae5c</code></pre></figure> <p><code class="highlighter-rouge">-f</code> 的作用与 <code class="highlighter-rouge">tail -f</code> 类似，能够持续打印输出。</p> <h2 id="运行容器的最佳实践">运行容器的最佳实践</h2> <p>按用途容器大致可分为两类：服务类容器和工具类的容器。</p> <ol> <li>服务类容器以 daemon 的形式运行，对外提供服务。比如 web server，数据库等。通过 <code class="highlighter-rouge">-d</code> 以后台方式启动这类容器是非常合适的。如果要排查问题，可以通过 <code class="highlighter-rouge">exec -it</code> 进入容器。</li> <li>工具类容器通常给能我们提供一个临时的工作环境，通常以 <code class="highlighter-rouge">run -it</code> 方式运行，比如：</li> </ol> <figure class="highlight"><pre><code class="language-shell" data-lang="shell">docker run <span class="nt">-it</span> busybox</code></pre></figure> <p>工具类容器多使用基础镜像，例如 busybox、debian、ubuntu 等。</p> <h3 id="容器运行小结">容器运行小结</h3> <p>容器运行相关的知识点：</p> <ol> <li>当 CMD 或 Entrypoint 或 docker run 命令行指定的命令运行结束时，容器停止。</li> <li>通过 <code class="highlighter-rouge">-d</code> 参数在后台启动容器。</li> <li>通过 <code class="highlighter-rouge">exec -it</code> 可进入容器并执行命令。</li> </ol> <p>指定容器的三种方法：</p> <ol> <li>短ID。</li> <li>长ID。</li> <li>容器名称。 可通过 <code class="highlighter-rouge">--name</code> 为容器命名。重命名容器可执行docker rename。</li> </ol> <p>容器按用途可分为两类：</p> <ol> <li>服务类的容器。</li> <li>工具类的容器。</li> </ol> 7098 </div> --> <div class="row content"> <ul id="markdown-toc"> <li><a href="#运行容器" id="markdown-toc-运行容器">运行容器</a></li> <li><a href="#让容器长期运行" id="markdown-toc-让容器长期运行">让容器长期运行</a></li> <li><a href="#两种进入容器的方法" id="markdown-toc-两种进入容器的方法">两种进入容器的方法</a> <ul> <li><a href="#docker-attach" id="markdown-toc-docker-attach">docker attach</a></li> <li><a href="#docker-exec" id="markdown-toc-docker-exec">docker exec</a></li> <li><a href="#attach-vs-exec" id="markdown-toc-attach-vs-exec">attach VS exec</a></li> </ul> </li> <li><a href="#运行容器的最佳实践" id="markdown-toc-运行容器的最佳实践">运行容器的最佳实践</a> <ul> <li><a href="#容器运行小结" id="markdown-toc-容器运行小结">容器运行小结</a></li> </ul> </li> </ul> <h2 id="运行容器">运行容器</h2> <p><code class="highlighter-rouge">docker run</code> 是启动容器的方法。在讨论 Dockerfile 时我们已经学习到，可用三种方式指定容器启动时执行的命令：</p> <ul> <li><code class="highlighter-rouge">CMD</code> 指令。</li> <li><code class="highlighter-rouge">ENDPOINT</code> 指令。</li> <li>在 <code class="highlighter-rouge">docker run</code> 命令行中指定。</li> </ul> <p>例如下面的例子：</p> <figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="o">[</span>root@dockerserver ~]# docker run centos <span class="nb">pwd</span>
/
<span class="o">[</span>root@dockerserver ~]# </code></pre></figure> <p>容器启动时执行 <code class="highlighter-rouge">pwd</code>，返回的 <code class="highlighter-rouge">/</code> 是容器中的当前目录。 执行 <code class="highlighter-rouge">docker ps</code> 或 <code class="highlighter-rouge">docker container ls</code> 可以查看 <code class="highlighter-rouge">Docker host</code> 中当前运行的容器：</p> <figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="o">[</span>root@dockerserver ~]# docker ps
CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES
<span class="o">[</span>root@dockerserver ~]# docker container <span class="nb">ls
</span>CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES

<span class="o">[</span>root@dockerserver ~]# docker ps <span class="nt">-a</span>
CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS                     PORTS               NAMES
e0be46060424        centos              <span class="s2">"pwd"</span>               3 minutes ago       Exited <span class="o">(</span>0<span class="o">)</span> 3 minutes ago 

<span class="o">[</span>root@dockerserver ~]# docker container <span class="nb">ls</span> <span class="nt">-a</span>
CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS                     PORTS               NAMES
e0be46060424        centos              <span class="s2">"pwd"</span>               3 minutes ago       Exited <span class="o">(</span>0<span class="o">)</span> 3 minutes ago                     
<span class="o">[</span>root@dockerserver ~]# </code></pre></figure> <p><code class="highlighter-rouge">-a</code> 会显示所有状态的容器，可以看到，之前的容器已经退出了，状态为Exited。</p> <h2 id="让容器长期运行">让容器长期运行</h2> <p>容器的生命周期依赖于启动时执行的命令，只要该命令不结束，容器也就不会退出。</p> <p>理解了这个原理，我们就可以通过执行一个长期运行的命令来保持容器的运行状态。例如执行下面的命令：</p> <figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="nv">$ </span>docker run centos /bin/bash <span class="nt">-c</span> <span class="s2">"while true; do sleep 1; done"</span>

<span class="nv">$ </span>docker ps
CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS               NAMES
eecca9576653        centos              <span class="s2">"/bin/bash -c 'whi..."</span>   44 seconds ago      Up 44 seconds  </code></pre></figure> <p><code class="highlighter-rouge">while</code> 语句让 bash 不会退出。不过这种方法有个缺点：它占用了一个终端。</p> <p>可以加上参数 -d 以后台方式启动容器。</p> <figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="nv">$ </span>docker run <span class="nt">-d</span> centos /bin/bash <span class="nt">-c</span> <span class="s2">"while true; do sleep 1; done"</span>
71cc983f0be3be4188edc861269ae05057ae070a8e0c210db71a48541bad8d54
<span class="nv">$ </span>docker ps
CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS               NAMES
71cc983f0be3        centos              <span class="s2">"/bin/bash -c 'whi..."</span>   6 seconds ago       Up 5 seconds                            romantic_wiles</code></pre></figure> <p>CONTAINER ID 是容器的 “短ID”，前面启动容器时返回的是 “长ID”。短ID是长ID的前12个字符。</p> <p><code class="highlighter-rouge">NAMES</code> 字段显示容器的名字，在启动容器时可以通过 <code class="highlighter-rouge">--name</code> 参数显示地为容器命名，如果不指定，docker 会自动为容器分配名字。</p> <p>对于容器的后续操作，我们需要通过 “长ID”、“短ID” 或者 “名称” 来指定要操作的容器。 比如停止一个容器：</p> <figure class="highlight"><pre><code class="language-shell" data-lang="shell">docker stop 71cc983f0be3</code></pre></figure> <p>容器常见的用途是运行后台服务，例如前面我们已经看到的 http server</p> <figure class="highlight"><pre><code class="language-shell" data-lang="shell">docker run <span class="nt">--name</span> myhttp <span class="nt">-d</span> httpd
docker <span class="nb">history </span>httpd</code></pre></figure> <p>这一次我们用 <code class="highlighter-rouge">--name</code> 指定了容器的名字。 我们还看到容器运行的命令是httpd-foreground，通过 docker history 可知这个命令是通过 CMD 指定的。</p> <figure class="highlight"><pre><code class="language-shell" data-lang="shell">docker run <span class="nt">--name</span> myhttp <span class="nt">-d</span> httpd
Unable to find image <span class="s1">'httpd:latest'</span> locally
latest: Pulling from library/httpd
9f0706ba7422: Downloading <span class="o">[==============&gt;</span>                                    <span class="o">]</span> 15.68 MB/52.61 MB
9f0706ba7422: Pull <span class="nb">complete 
</span>47bacf36113f: Pull <span class="nb">complete 
</span>56798d8e5a30: Pull <span class="nb">complete 
</span>94b25413538a: Pull <span class="nb">complete 
</span>97d879f4e260: Pull <span class="nb">complete 
</span>2a4f7e960a3e: Pull <span class="nb">complete 
</span>12f5eb531290: Pull <span class="nb">complete 
</span>Digest: sha256:8f58a3ef340038615498cead8b83fa3b31e4fe5c16961c6c3635e973ac9303ed
Status: Downloaded newer image <span class="k">for </span>httpd:latest
a088fcb283345b36f17a679a326d1507d300e07f5a3c00123613afc055c12e0c


docker ps
CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS               NAMES
a088fcb28334        httpd               <span class="s2">"httpd-foreground"</span>       8 minutes ago       Up 8 minutes        80/tcp              myhttp
71cc983f0be3        centos              <span class="s2">"/bin/bash -c 'whi..."</span>   40 minutes ago      Up 40 minutes                           romantic_wiles


docker <span class="nb">history </span>httpd
IMAGE               CREATED             CREATED BY                                      SIZE                COMMENT
b1e597b50dd7        7 days ago          /bin/sh <span class="nt">-c</span> <span class="c">#(nop)  CMD ["httpd-foreground"]     0 B</span>
&lt;missing&gt;           7 days ago          /bin/sh <span class="nt">-c</span> <span class="c">#(nop)  EXPOSE 80/tcp                0 B</span>
&lt;missing&gt;           7 days ago          /bin/sh <span class="nt">-c</span> <span class="c">#(nop) COPY file:761e313354b918...   133 B</span>
&lt;missing&gt;           7 days ago          /bin/sh <span class="nt">-c</span> <span class="nb">set</span> <span class="nt">-x</span>  <span class="o">&amp;&amp;</span> <span class="nv">buildDeps</span><span class="o">=</span><span class="s2">"   bzip2 ...   9.68 MB
&lt;missing&gt;           7 days ago          /bin/sh -c #(nop)  ENV HTTPD_ASC_URL=https...   0 B 
&lt;missing&gt;           7 days ago          /bin/sh -c #(nop)  ENV HTTPD_BZ2_URL=https...   0 B
&lt;missing&gt;           7 days ago          /bin/sh -c #(nop)  ENV HTTPD_SHA1=bd6d138c...   0 B
&lt;missing&gt;           7 days ago          /bin/sh -c #(nop)  ENV HTTPD_VERSION=2.4.25     0 B
&lt;missing&gt;           7 days ago          /bin/sh -c apt-get update  &amp;&amp; apt-get inst...   44.2 MB
&lt;missing&gt;           7 days ago          /bin/sh -c {   echo 'deb http://deb.debian...   161 B
&lt;missing&gt;           7 days ago          /bin/sh -c #(nop)  ENV OPENSSL_VERSION=1.0...   0 B
&lt;missing&gt;           7 days ago          /bin/sh -c #(nop)  ENV NGHTTP2_VERSION=1.1...   0 B
&lt;missing&gt;           7 days ago          /bin/sh -c #(nop) WORKDIR /usr/local/apache2    0 B
&lt;missing&gt;           7 days ago          /bin/sh -c mkdir -p "</span><span class="nv">$HTTPD_PREFIX</span><span class="s2">"  &amp;&amp; ch...   0 B
&lt;missing&gt;           7 days ago          /bin/sh -c #(nop)  ENV PATH=/usr/local/apa...   0 B
&lt;missing&gt;           7 days ago          /bin/sh -c #(nop)  ENV HTTPD_PREFIX=/usr/l...   0 B
&lt;missing&gt;           9 days ago          /bin/sh -c echo 'deb http://deb.debian.org...   55 B
&lt;missing&gt;           9 days ago          /bin/sh -c #(nop)  CMD ["</span>bash<span class="s2">"]                 0 B
&lt;missing&gt;           9 days ago          /bin/sh -c #(nop) ADD file:9c48682ff75c756...   123 MB     </span></code></pre></figure> <h2 id="两种进入容器的方法">两种进入容器的方法</h2> <p>我们经常需要进到容器里去做一些工作，比如查看日志、调试、启动其他进程等。有两种方法进入容器：<code class="highlighter-rouge">attach</code> 和 <code class="highlighter-rouge">exec</code>。</p> <h3 id="docker-attach">docker attach</h3> <p>通过 docker attach 可以 attach 到容器启动命令的终端，例如：</p> <figure class="highlight"><pre><code class="language-shell" data-lang="shell">docker ps
CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS               NAMES
e787420eca98        centos              <span class="s2">"/bin/bash -c 'whi..."</span>   9 seconds ago       Up 8 seconds                            elegant_hawking
<span class="o">[</span>root@dockerclient docker]# docker attach e7874</code></pre></figure> <blockquote> <p>注：可通过 Ctrl+p 然后 Ctrl+q 组合键退出 attach 终端。</p> </blockquote> <h3 id="docker-exec">docker exec</h3> <p>通过 <code class="highlighter-rouge">docker exec</code> 进入相同的容器：</p> <figure class="highlight"><pre><code class="language-shell" data-lang="shell">docker <span class="nb">exec</span> <span class="nt">-it</span> e7874 bash</code></pre></figure> <p>说明如下：</p> <ol> <li><code class="highlighter-rouge">-it</code> 以交互模式打开 pseudo-TTY，执行 bash，其结果就是打开了一个 bash 终端。</li> <li>进入到容器中，容器的 hostname 就是其 “短ID”。</li> <li>可以像在普通 Linux 中一样执行命令。<code class="highlighter-rouge">ps -elf</code> 显示了容器启动进程while 以及当前的 bash 进程。</li> <li>执行 exit 退出容器，回到 docker host。</li> </ol> <figure class="highlight"><pre><code class="language-shell" data-lang="shell">docker <span class="nb">exec</span> <span class="nt">-it</span> &lt;container&gt; bash|sh 是执行 <span class="nb">exec </span>最常用的方式。</code></pre></figure> <h3 id="attach-vs-exec">attach VS exec</h3> <p>attach 与 exec 主要区别如下:</p> <ul> <li><code class="highlighter-rouge">attach</code> 直接进入容器 <strong>启动命令</strong> 的终端，不会启动新的进程。</li> <li><code class="highlighter-rouge">exec</code> 则是在容器中打开新的终端，并且可以启动新的进程。</li> <li>如果想直接在终端中查看启动命令的输出，用 <code class="highlighter-rouge">attach</code>；其他情况使用 <code class="highlighter-rouge">exec</code>。</li> </ul> <p>查看启动命令输出，使用 <code class="highlighter-rouge">docker logs</code></p> <figure class="highlight"><pre><code class="language-shell" data-lang="shell">docker logs <span class="nt">-f</span> 1328d892ae5c</code></pre></figure> <p><code class="highlighter-rouge">-f</code> 的作用与 <code class="highlighter-rouge">tail -f</code> 类似，能够持续打印输出。</p> <h2 id="运行容器的最佳实践">运行容器的最佳实践</h2> <p>按用途容器大致可分为两类：服务类容器和工具类的容器。</p> <ol> <li>服务类容器以 daemon 的形式运行，对外提供服务。比如 web server，数据库等。通过 <code class="highlighter-rouge">-d</code> 以后台方式启动这类容器是非常合适的。如果要排查问题，可以通过 <code class="highlighter-rouge">exec -it</code> 进入容器。</li> <li>工具类容器通常给能我们提供一个临时的工作环境，通常以 <code class="highlighter-rouge">run -it</code> 方式运行，比如：</li> </ol> <figure class="highlight"><pre><code class="language-shell" data-lang="shell">docker run <span class="nt">-it</span> busybox</code></pre></figure> <p>工具类容器多使用基础镜像，例如 busybox、debian、ubuntu 等。</p> <h3 id="容器运行小结">容器运行小结</h3> <p>容器运行相关的知识点：</p> <ol> <li>当 CMD 或 Entrypoint 或 docker run 命令行指定的命令运行结束时，容器停止。</li> <li>通过 <code class="highlighter-rouge">-d</code> 参数在后台启动容器。</li> <li>通过 <code class="highlighter-rouge">exec -it</code> 可进入容器并执行命令。</li> </ol> <p>指定容器的三种方法：</p> <ol> <li>短ID。</li> <li>长ID。</li> <li>容器名称。 可通过 <code class="highlighter-rouge">--name</code> 为容器命名。重命名容器可执行docker rename。</li> </ol> <p>容器按用途可分为两类：</p> <ol> <li>服务类的容器。</li> <li>工具类的容器。</li> </ol> <div class="col-sm-2 image pull-right"> <img class="avatar-img avata" style='border="0";border-radius: 50%' src="http://www.forbackup.tk/assets/img/author/blog.svg" alt="" height="32px" width="32px"> </div> </div> <ul class="pager"> <li><a href="/docker_col/2017/07/30/docker-learn-07.html">Docker系列 7 Registry</a></li> <li><a href="/docker_col/2017/08/05/docker-learn-09.html">Docker系列 9 容器常用操作</a></li> </ul> </article> </div> </div> </div> <div class="footer"> <div class="container-fluid"> <div class="row-fluid"> <div class="col-sm-4 copyright"> <span>Vicky's Blog © 2018 • All right reserved.</span> </div> <div class="col-sm-4 message"> <span>Simplicity is fashionable.</span> </div> <div class="col-sm-4 madeby"> <span>Made with&nbsp;<a href="https://jekyllrb.com" target="_blank">Jekyll</a>&nbsp;by&nbsp;Vicky.</span> </div> <a class="pull-right top" href="#top"><i class="fa fa-caret-up" aria-hidden="true"></i></a> </div> </div> </div> </div> <!-- Vendor - Global | Applicable to every website --> <!-- #### VENDOR OFFLINE #### --> <script src="http://www.forbackup.tk/assets/vendor-off/jquery/js/jquery.min.js"></script> <script src="http://www.forbackup.tk/assets/vendor-off/bootstrap/js/bootstrap.min.js"></script> <script defer src="http://www.forbackup.tk/assets/vendor-off/font-awesome/svg-with-js/js/fontawesome-all.min.js"></script> <script src="http://www.forbackup.tk/assets/javascripts/jekyll-spotify-plugin.min.js"></script> <!-- Specific for each pages. --> <script type="text/javascript" src="http://www.forbackup.tk/assets/javascripts/post.js"></script> <!-- Add 'ga' function from Google Analytics to certain site links in Posts --> <!-- App | Global --> <script src="http://www.forbackup.tk/assets/javascripts/global.js"></script> </body> </html>




    



<!-- Include Data Base --> <!DOCTYPE html> <html lang="en" itemscope itemtype="http://schema.org/WebPage"> <head> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title>Docker系列 14 容器如何访问外部世界 | Vicky's Blog </title> <meta name=description content=""> <meta name="robots" content="index, follow"> <meta name=viewport content="width=device-width, initial-scale=1"> <meta http-equiv="cache-control" content="public"/> <meta http-equiv="pragma" content="public"> <meta name="keywords" content="Theme, Jekyll" /> <meta name="author" content="" /> <meta property="og:locale" content="en" /> <meta property="og:site_name" content="Vicky's Blog" /> <meta property="og:type" content="WebSite" /> <meta property="og:url" content="http://www.forbackup.tk/docker_col/2017/08/06/docker-learn-14.html" /> <meta property="og:description" content="" /> <meta property="og:title" content="Docker系列 14 容器如何访问外部世界 - Vicky's Blog" /> <link rel="canonical" href="http://www.forbackup.tk/docker_col/2017/08/06/docker-learn-14.html"> <link rel="alternate" type="application/rss+xml" title="Vicky's Blog" href="http://www.forbackup.tk/feed.xml"> <script type="application/ld+json"> {"@context": "http://schema.org", "@type": "WebSite", "name": "", "headline": "Vicky's Blog", "author": {"@type": "Person", "name": {"Vicky's Blog"}}, "description": "", "url": "http://www.forbackup.tk"} </script> <script type="text/javascript"> var GLOBAL_BASEURL = "http://www.forbackup.tk"; </script> <link rel="icon" type="image/png" sizes="16x16" href="http://www.forbackup.tk/assets/img/favicon/favicon-16x16.png"> <!-- #### VENDOR OFFLINE #### --> <!-- Bootstrap 3.3.6 - Offline --> <link rel="stylesheet" href="http://www.forbackup.tk/assets/vendor-off/bootstrap/css/bootstrap.min.css"> <!-- Font Awesome 5.03 - Offline --> <script defer src="http://www.forbackup.tk/assets/vendor-off/font-awesome/web-fonts-with-css/css/fontawesome-all.min.css"></script> <link rel="stylesheet" href="http://www.forbackup.tk/assets/vendor-off/fonts/space-mono/space-mono.min.css"> <link rel="stylesheet" href="http://www.forbackup.tk/assets/vendor-off/fonts/gloria-hallelujah/gloria-hallelujah.min.css"> <!-- Style Default --> <link rel="stylesheet" href="http://www.forbackup.tk/assets/stylesheets/main.css"> <!-- Google Analytics --> </head> <body> <div class="main" id="top"> <div class="container wrapper"> <div class="row"> <div class="col-sm-3 sidebar"> <div class="row avatar"> <a href="http://www.forbackup.tk/"> <img class="img-responsive center-block avatar-img" src="http://www.forbackup.tk/assets/img/avatar/blog.svg" height="165" width="165" alt="Vicky's Blog"> </a> </div> <div class="row header"> <h2><a href="http://www.forbackup.tk/">Vicky </a></h2> </div> <div class="row menu"> <ul> <li> <i class="fa fa-home" aria-hidden="true"></i>&nbsp;<a href="http://www.forbackup.tk/">Home</a> </li> <hr class="breakline"> <li class="li-folder-open"> <i style="font-size: ;" class="fas fa-folder-open"></i>&nbsp;<a class="unlink">Blog</a> </li> <li class="li-fa-edit"> <i style="font-size: ;" class="fas fa-edit" aria-hidden="true"></i>&nbsp;<a href="http://www.forbackup.tk/general/" >General</a> </li> <li class="li-fa-docker"> <i style="font-size: ;" class="fab fa-docker" aria-hidden="true"></i>&nbsp;<a href="http://www.forbackup.tk/docker_col/" >Docker</a> </li> <li class="li-fa-table"> <i style="font-size: ;" class="fas fa-table" aria-hidden="true"></i>&nbsp;<a href="http://www.forbackup.tk/data_analysis/" >Data Analysis</a> </li> <li class="li-fa-tags"> <i style="font-size: ;" class="fas fa-tags" aria-hidden="true"></i>&nbsp;<a href="http://www.forbackup.tk/blog/tags/" >Tags</a> </li> <li class="li-fa-briefcase"> <i style="font-size: ;" class="fas fa-briefcase" aria-hidden="true"></i>&nbsp;<a href="http://www.forbackup.tk/blog/projects/" >Projects</a> </li> </ul> <div class="socials"> <div class="row"> <p></p> <p></p> </div> </div> </div> </div> <div class="col-sm-9 content-main"> <!-- Include Data Base --> <article class="post" itemscope itemtype="http://schema.org/BlogPosting"> <!-- Next Version <div class="readmode"> <a id="btn-readmode" class="pull-right btn btn-default btn-readmode" href="">Read Mode</a> </div> --> <div class="row title"> <h1>Docker系列 14 容器如何访问外部世界</h1> </div> <div class="row meta" datetime="2017-08-06"> <time class="col-sm-6 datetime"> <i class="fa fa-calendar" aria-hidden="true"></i> <span class="text tmargin ">August 06, 2017</span> </time> </div> <div class="row tag-list"> <i class="fa fa-tags" aria-hidden="true"></i> <a href="http://www.forbackup.tk/blog/tags//linux">linux</a> <a href="http://www.forbackup.tk/blog/tags//docker">docker</a> </div> <!-- <div class="row"> <ul id="markdown-toc"> <li><a href="#相关命令" id="markdown-toc-相关命令">相关命令</a></li> <li><a href="#容器访问外部世界" id="markdown-toc-容器访问外部世界">容器访问外部世界</a></li> </ul> <h2 id="相关命令">相关命令</h2> <figure class="highlight"><pre><code class="language-shell" data-lang="shell">docker build <span class="nt">-t</span> localtcpdump <span class="nb">.</span>
docker run <span class="nt">--rm</span> <span class="nt">-v</span> /opt/bin:/target localtcpdump
docker run <span class="nt">--rm</span> <span class="nt">-v</span> /opt/bin:/target ulexus/install-tcpdump

docker run <span class="nt">-it</span> busybox
ip r</code></pre></figure> <p>容器与外部世界通信。这里涉及两个方向：</p> <ul> <li>容器访问外部世界</li> <li>外部世界访问容器</li> </ul> <h2 id="容器访问外部世界">容器访问外部世界</h2> <p>在我们当前的实验环境下，docker host 是可以访问外网的。</p> <figure class="highlight"><pre><code class="language-shell" data-lang="shell">docker run <span class="nt">-it</span> busybox
ip r

ping <span class="nt">-c</span> 3 www.bing.com</code></pre></figure> <p><strong>容器默认就能访问外网</strong></p> <p>d0httpd1 位于 docker0 这个私有 bridge 网络中（172.17.0.0/16），当 d0httpd1 从容器向外 ping 时，数据包是怎样到达 bing.com 的呢？</p> <p>这里的关键就是 NAT。我们查看一下 docker host 上的 iptables 规则：</p> <figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="nv">$ </span>iptables <span class="nt">-t</span> nas <span class="nt">-S</span>
...
<span class="nt">-A</span> POSTROUTING <span class="nt">-s</span> 172.18.0.0/16 <span class="o">!</span> <span class="nt">-o</span> br-d430eab46516 <span class="nt">-j</span> MASQUERADE
<span class="nt">-A</span> POSTROUTING <span class="nt">-s</span> 172.17.0.0/16 <span class="o">!</span> <span class="nt">-o</span> docker0 <span class="nt">-j</span> MASQUERADE
...</code></pre></figure> <p>在 NAT 表中，有这么一条规则：</p> <p>-A POSTROUTING -s 172.17.0.0/16 ! -o docker0 -j MASQUERADE</p> <p>其含义是：如果网桥 docker0 收到来自 172.17.0.0/16 网段的外出包，把它交给 MASQUERADE 处理。而 MASQUERADE 的处理方式是将包的源地址替换成 host 的地址发送出去，即做了一次网络地址转换（NAT）。</p> <p>下面我们通过 <code class="highlighter-rouge">tcpdump</code> 查看地址是如何转换的。先查看 docker host 的路由表：</p> <figure class="highlight"><pre><code class="language-shell" data-lang="shell">/ <span class="c"># ip r</span>
default via 172.17.0.1 dev eth0 
172.17.0.0/16 dev eth0 scope <span class="nb">link  </span>src 172.17.0.3 </code></pre></figure> <p>默认路由通过 eth0 发出去，所以我们要同时监控 eth0 和 br-d430eab46516 上的 icmp（ping）数据包。</p> <p>当 http2 ping bing.com 时，tcpdump 输出如下：</p> <figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="nv">$ </span>tcpdump <span class="nt">-i</span> docker0 <span class="nt">-n</span> icmp
tcpdump: verbose output suppressed, use <span class="nt">-v</span> or <span class="nt">-vv</span> <span class="k">for </span>full protocol decode
listening on docker0, link-type EN10MB <span class="o">(</span>Ethernet<span class="o">)</span>, capture size 262144 bytes
02:16:03.749073 IP 172.17.0.3 <span class="o">&gt;</span> 202.89.233.100: ICMP <span class="nb">echo </span>request, <span class="nb">id </span>1792, <span class="nb">seq </span>0, length 64
02:16:03.789452 IP 202.89.233.100 <span class="o">&gt;</span> 172.17.0.3: ICMP <span class="nb">echo </span>reply, <span class="nb">id </span>1792, <span class="nb">seq </span>0, length 64
02:16:04.749523 IP 172.17.0.3 <span class="o">&gt;</span> 202.89.233.100: ICMP <span class="nb">echo </span>request, <span class="nb">id </span>1792, <span class="nb">seq </span>1, length 64
02:16:04.789413 IP 202.89.233.100 <span class="o">&gt;</span> 172.17.0.3: ICMP <span class="nb">echo </span>reply, <span class="nb">id </span>1792, <span class="nb">seq </span>1, length 64
02:16:05.749962 IP 172.17.0.3 <span class="o">&gt;</span> 202.89.233.100: ICMP <span class="nb">echo </span>request, <span class="nb">id </span>1792, <span class="nb">seq </span>2, length 64
02:16:05.790665 IP 202.89.233.100 <span class="o">&gt;</span> 172.17.0.3: ICMP <span class="nb">echo </span>reply, <span class="nb">id </span>1792, <span class="nb">seq </span>2, length 64</code></pre></figure> <p>docker0 收到 必须busybox 的 ping 包，源地址为容器 IP 172.17.0.3，这没问题，交给 MASQUERADE 处理。这时，在 eth0 上我们看到了变化：</p> <figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="c"># 机器没有设备 eth0</span>
<span class="nv">$ </span>tcpdump <span class="nt">-i</span> eth0 <span class="nt">-n</span> icmp</code></pre></figure> 1921 </div> --> <div class="row content"> <ul id="markdown-toc"> <li><a href="#相关命令" id="markdown-toc-相关命令">相关命令</a></li> <li><a href="#容器访问外部世界" id="markdown-toc-容器访问外部世界">容器访问外部世界</a></li> </ul> <h2 id="相关命令">相关命令</h2> <figure class="highlight"><pre><code class="language-shell" data-lang="shell">docker build <span class="nt">-t</span> localtcpdump <span class="nb">.</span>
docker run <span class="nt">--rm</span> <span class="nt">-v</span> /opt/bin:/target localtcpdump
docker run <span class="nt">--rm</span> <span class="nt">-v</span> /opt/bin:/target ulexus/install-tcpdump

docker run <span class="nt">-it</span> busybox
ip r</code></pre></figure> <p>容器与外部世界通信。这里涉及两个方向：</p> <ul> <li>容器访问外部世界</li> <li>外部世界访问容器</li> </ul> <h2 id="容器访问外部世界">容器访问外部世界</h2> <p>在我们当前的实验环境下，docker host 是可以访问外网的。</p> <figure class="highlight"><pre><code class="language-shell" data-lang="shell">docker run <span class="nt">-it</span> busybox
ip r

ping <span class="nt">-c</span> 3 www.bing.com</code></pre></figure> <p><strong>容器默认就能访问外网</strong></p> <p>d0httpd1 位于 docker0 这个私有 bridge 网络中（172.17.0.0/16），当 d0httpd1 从容器向外 ping 时，数据包是怎样到达 bing.com 的呢？</p> <p>这里的关键就是 NAT。我们查看一下 docker host 上的 iptables 规则：</p> <figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="nv">$ </span>iptables <span class="nt">-t</span> nas <span class="nt">-S</span>
...
<span class="nt">-A</span> POSTROUTING <span class="nt">-s</span> 172.18.0.0/16 <span class="o">!</span> <span class="nt">-o</span> br-d430eab46516 <span class="nt">-j</span> MASQUERADE
<span class="nt">-A</span> POSTROUTING <span class="nt">-s</span> 172.17.0.0/16 <span class="o">!</span> <span class="nt">-o</span> docker0 <span class="nt">-j</span> MASQUERADE
...</code></pre></figure> <p>在 NAT 表中，有这么一条规则：</p> <p>-A POSTROUTING -s 172.17.0.0/16 ! -o docker0 -j MASQUERADE</p> <p>其含义是：如果网桥 docker0 收到来自 172.17.0.0/16 网段的外出包，把它交给 MASQUERADE 处理。而 MASQUERADE 的处理方式是将包的源地址替换成 host 的地址发送出去，即做了一次网络地址转换（NAT）。</p> <p>下面我们通过 <code class="highlighter-rouge">tcpdump</code> 查看地址是如何转换的。先查看 docker host 的路由表：</p> <figure class="highlight"><pre><code class="language-shell" data-lang="shell">/ <span class="c"># ip r</span>
default via 172.17.0.1 dev eth0 
172.17.0.0/16 dev eth0 scope <span class="nb">link  </span>src 172.17.0.3 </code></pre></figure> <p>默认路由通过 eth0 发出去，所以我们要同时监控 eth0 和 br-d430eab46516 上的 icmp（ping）数据包。</p> <p>当 http2 ping bing.com 时，tcpdump 输出如下：</p> <figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="nv">$ </span>tcpdump <span class="nt">-i</span> docker0 <span class="nt">-n</span> icmp
tcpdump: verbose output suppressed, use <span class="nt">-v</span> or <span class="nt">-vv</span> <span class="k">for </span>full protocol decode
listening on docker0, link-type EN10MB <span class="o">(</span>Ethernet<span class="o">)</span>, capture size 262144 bytes
02:16:03.749073 IP 172.17.0.3 <span class="o">&gt;</span> 202.89.233.100: ICMP <span class="nb">echo </span>request, <span class="nb">id </span>1792, <span class="nb">seq </span>0, length 64
02:16:03.789452 IP 202.89.233.100 <span class="o">&gt;</span> 172.17.0.3: ICMP <span class="nb">echo </span>reply, <span class="nb">id </span>1792, <span class="nb">seq </span>0, length 64
02:16:04.749523 IP 172.17.0.3 <span class="o">&gt;</span> 202.89.233.100: ICMP <span class="nb">echo </span>request, <span class="nb">id </span>1792, <span class="nb">seq </span>1, length 64
02:16:04.789413 IP 202.89.233.100 <span class="o">&gt;</span> 172.17.0.3: ICMP <span class="nb">echo </span>reply, <span class="nb">id </span>1792, <span class="nb">seq </span>1, length 64
02:16:05.749962 IP 172.17.0.3 <span class="o">&gt;</span> 202.89.233.100: ICMP <span class="nb">echo </span>request, <span class="nb">id </span>1792, <span class="nb">seq </span>2, length 64
02:16:05.790665 IP 202.89.233.100 <span class="o">&gt;</span> 172.17.0.3: ICMP <span class="nb">echo </span>reply, <span class="nb">id </span>1792, <span class="nb">seq </span>2, length 64</code></pre></figure> <p>docker0 收到 必须busybox 的 ping 包，源地址为容器 IP 172.17.0.3，这没问题，交给 MASQUERADE 处理。这时，在 eth0 上我们看到了变化：</p> <figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="c"># 机器没有设备 eth0</span>
<span class="nv">$ </span>tcpdump <span class="nt">-i</span> eth0 <span class="nt">-n</span> icmp</code></pre></figure> <div class="col-sm-2 image pull-right"> <img class="avatar-img avata" style='border="0";border-radius: 50%' src="http://www.forbackup.tk/assets/img/author/blog.svg" alt="" height="32px" width="32px"> </div> </div> <ul class="pager"> <li><a href="/docker_col/2017/08/06/docker-learn-13.html">Docker系列 13 理解容器之间的连通性</a></li> <li><a href="/general/2018/01/01/set-jekyll-env.html">Jekyll 环境配置</a></li> </ul> </article> </div> </div> </div> <div class="footer"> <div class="container-fluid"> <div class="row-fluid"> <div class="col-sm-4 copyright"> <span>Vicky's Blog © 2018 • All right reserved.</span> </div> <div class="col-sm-4 message"> <span>Simplicity is fashionable.</span> </div> <div class="col-sm-4 madeby"> <span>Made with&nbsp;<a href="https://jekyllrb.com" target="_blank">Jekyll</a>&nbsp;by&nbsp;Vicky.</span> </div> <a class="pull-right top" href="#top"><i class="fa fa-caret-up" aria-hidden="true"></i></a> </div> </div> </div> </div> <!-- Vendor - Global | Applicable to every website --> <!-- #### VENDOR OFFLINE #### --> <script src="http://www.forbackup.tk/assets/vendor-off/jquery/js/jquery.min.js"></script> <script src="http://www.forbackup.tk/assets/vendor-off/bootstrap/js/bootstrap.min.js"></script> <script defer src="http://www.forbackup.tk/assets/vendor-off/font-awesome/svg-with-js/js/fontawesome-all.min.js"></script> <script src="http://www.forbackup.tk/assets/javascripts/jekyll-spotify-plugin.min.js"></script> <!-- Specific for each pages. --> <script type="text/javascript" src="http://www.forbackup.tk/assets/javascripts/post.js"></script> <!-- Add 'ga' function from Google Analytics to certain site links in Posts --> <!-- App | Global --> <script src="http://www.forbackup.tk/assets/javascripts/global.js"></script> </body> </html>
